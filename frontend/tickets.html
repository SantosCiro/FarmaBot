<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FarmaBot - Tickets</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    button { padding: 10px 14px; border:0; border-radius: 10px; cursor:pointer; }
    button:hover { opacity:.9; }
    input { padding:10px; border:1px solid #ddd; border-radius:10px; width:120px; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #eee; vertical-align: top; }
    th { background:#fafafa; }
    .muted { color:#666; font-size: 12px; }
    .pill { display:inline-block; padding:4px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; }
    .msg { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0;">Tickets (atendimentos encaminhados)</h2>
        <span class="muted">API: <span id="apiUrl"></span></span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="refresh">Atualizar</button>
        <label class="muted">Limite:</label>
        <input id="limit" type="number" value="50" min="1" max="200" />
        <span class="muted">Dica: abra um ticket no chat e clique em “Atualizar”.</span>
      </div>

      <div id="status" class="muted" style="margin-top:10px;"></div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Quando</th>
            <th>Cliente</th>
            <th>Mensagem</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Nenhum ticket carregado ainda.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API = "http://127.0.0.1:8000";
    document.getElementById("apiUrl").textContent = API;

    const tbody = document.getElementById("tbody");
    const statusEl = document.getElementById("status");
    const limitEl = document.getElementById("limit");

    function escapeHtml(s) {
      return (s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function renderTickets(tickets) {
      if (!tickets || tickets.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Nenhum ticket encontrado.</td></tr>`;
        return;
      }

      tbody.innerHTML = tickets.map(t => {
        const who = [t.name, t.phone].filter(Boolean).join(" • ") || "(não informado)";
        const when = t.created_at ? t.created_at.replace("T", " ").slice(0, 19) : "";
        return `
          <tr>
            <td><strong>${t.id}</strong></td>
            <td class="muted">${escapeHtml(when)}</td>
            <td>${escapeHtml(who)}</td>
            <td class="msg">${escapeHtml(t.message)}</td>
            <td><span class="pill">${escapeHtml(t.status)}</span></td>
          </tr>
        `;
      }).join("");
    }

    async function loadTickets() {
      const limit = Number(limitEl.value || 50);
      statusEl.textContent = "Carregando...";
      try {
        const res = await fetch(`${API}/tickets?limit=${limit}`);
        const data = await res.json();
        renderTickets(data.tickets);
        statusEl.textContent = `Carregado: ${data.tickets.length} ticket(s).`;
      } catch (e) {
        statusEl.textContent = "Erro ao carregar. O backend está rodando em http://127.0.0.1:8000 ?";
      }
    }

    document.getElementById("refresh").addEventListener("click", loadTickets);

    // carrega ao abrir
    loadTickets();
  </script>
</body>
</html>
